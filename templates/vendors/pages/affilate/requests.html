{% extends 'vendors/base.html' %}
{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>طلبات سحب</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-left">
            <li class="breadcrumb-item">
              <a href="#">افيليت</a>
            </li>
            <li class="breadcrumb-item active">طلبات سحب</li>
          </ol>
        </div>
      </div>
    </div>
    <!-- /.container-fluid -->
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row"></div>
      <!-- /.card -->
      <div class="card">
        <!--  <div class="card-header">
                <h3 class="card-title">طلبات سحب</h3>
              </div>  -->
        <!-- /.card-header -->
        <div id="error-message-container" class="alert alert-danger" style="display: none;"></div>
        <div id="success-message-container" class="alert alert-success" style="display: none;"></div>
        <div class="card-body">

          <button id="addRowBtn" class="btn btn-primary float-right"><i class="fas fa-plus"></i></button>


          <!-- Add these input fields above the DataTable -->
          <form class="form-group row m-2">
            <label class="form-label" for="date_range"> تاريخ: </label>
            <div class="col-xs-3 ml-">
              <input type="text" class="form-control" id="date_range">
            </div>
            <div class="col">
              <button type="button" class="btn btn-primary" id="submitBtn">فلتر</button>
            </div>
          </form>
          <table id="example2" class="table table-bordered table-striped table-hover">
            <thead class="bg-primary">
              <tr>
                <th>#</th>
                <th>اسم المستخدم</th>
                <th>المبلغ</th>
                <th>الحالة</th>
                <th>الوسيلة</th>
                <th>فودافون كاش</th>
                <th>انستا باي</th>
                <th>حساب بنكي</th>
                <th>ملاحظة</th>
                <th>انشئت في</th>
                <th>حدثت في</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
            <tfoot>
              <tr>
                <th>#</th>
                <th>اسم المستخدم</th>
                <th>المبلغ</th>
                <th>الحالة</th>
                <th>الوسيلة</th>
                <th>فودافون كاش</th>
                <th>انستا باي</th>
                <th>حساب بنكي</th>  
                <th>ملاحظة</th>
                <th>انشئت في</th>
                <th>حدثت في</th>
              </tr>
            </tfoot>
          </table>


          <!-- Add Request Modal -->
          <div class="modal fade" id="addRequestModal" tabindex="-1" role="dialog"
            aria-labelledby="addRequestModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="addRequestModalLabel">اضافة طلب سحب جديد</h5>
                  <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post">
                    {% csrf_token %}
                    <p>{{ form.amount }}</p>
                    <p>{{ form.payment_method }}</p>
                    <div id="vodafone_field" class="payment-specific-field" style="display: none;">
                      <p>{{ form.vodafone_field }}</p>
                    </div>
                    <div id="instapay_field" class="payment-specific-field" style="display: none;">
                      <p>{{ form.instapay_field }}</p>
                    </div>
                    <div id="bank_field" class="payment-specific-field" style="display: none;">
                      <p>{{ form.bank_field }}</p>
                    </div>
                      <p>{{ form.note }}</p>
                    
                  </form>
                </div>
                <div class="modal-footer">
                  <div class="form-group">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="">اغلاق</button>
                    <button type="submit" class="btn btn-primary" id="saveRequestBtn">حفظ</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- /.card-body -->
      </div>

    </div>
    <!-- /.card -->
    <!-- /.col -->
    <!-- /.row -->
    <!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
<!-- /.content-wrapper -->


<!-- Datatable -->
<script>
  var dataTable;
  $(function () {

    // Initialize Date Range Picker
    var tomorrow = moment().add(1, 'days');
    $('#date_range').daterangepicker({
      locale: {
        format: 'YYYY-MM-DD',
        applyLabel: 'تطبيق',
        cancelLabel: 'إلغاء',
        customRangeLabel: 'نطاق مخصص',
      },
      startDate: '2023-01-01',
      endDate: tomorrow,
    });

    // Get the API URL using Django template syntax
    var apiUrl = "affiliate/api/vendor_api/";
    console.log("API URL:", apiUrl);

    // Initialize DataTables
    dataTable = $('#example2').DataTable({
      "language": {
        "url": "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Arabic.json"
      },
      'processing': true,
      'serverSide': true,
      "lengthMenu": [10, 100, 500, 1000],
      'ajax': {
        'url': '/affiliate/api/requests_api_vendor/Hisham/datatable_list/',
        'type': 'GET',
        'data': function (d) {
          d.extra_search = {};  // Add an object to store individual column searches

          // Add date filters from Date Range Picker
          var dateRange = $('#date_range').val();
          if (dateRange) {
            var [startDate, endDate] = dateRange.split(' - ');
            d.start_date = startDate;
            d.end_date = endDate;
          }

          // Add individual column searches
          $('input.column-search').each(function () {
            var columnIdx = $(this).data('column-index');
            var columnName = dataTable.column(columnIdx).dataSrc();
            d.extra_search[columnName] = $(this).val();
          });
        },
      },
      'columns': [
        { 'data': 'id' },
        { 'data': 'username' },
        { 'data': 'amount' },
        { 'data': 'status' },
        { 'data': 'payment_method' },
        { 'data': 'vodafone_field' },
        { 'data': 'instapay_field' },
        { 'data': 'bank_field' },
        { 'data': 'note' },
        { 'data': 'created_at', 'visible': false },
        { 'data': 'updated_at', 'visible': false },
        // {
        //   'data': null,
        //   'render': function (data, type, row) {
        //     // Add Edit and Delete buttons for each row
        //     return '<button class="btn btn-warning edit-btn" data-id="' + row.id + '">تعديل</button>' +
        //       '<button class="btn btn-danger delete-btn" data-id="' + row.id + '">حذف</button>';
        //   },
        //   'orderable': false,
        //   "searchable": false
        // },
        // Add other columns as needed
      ],
      'order': [], // Disable default sorting
      dom: 'frBtip',
      scrollY: 500,
      scrollX: true,
      responsive: false,
      lengthChange: true,
      autoWidth: false,
      select: true,
      buttons: ['pageLength', 'copy', 'csv', 'excel', 'pdf', 'print', 'colvis'],
      initComplete: function () {
        // Add individual column search inputs with placeholders
        this.api().columns().every(function () {
          var column = this;
          var input = document.createElement("input");
          $(input)
            .addClass('column-search')
            .attr('placeholder', 'ابحث ' + column.header().innerHTML)
            .data('column-index', column.index())
            .appendTo($(column.footer()).empty())
            .on('keyup change', function () {
              dataTable.draw();
            });
        });
      }
    });
  });

</script>

<!-- Redraw table -->
<script>
  // Handle click on the "Submit" button to redraw the table
  $('#submitBtn').click(function () {
    dataTable.draw();
  });
</script>


<!-- Show Message -->
<script>
  function showErrorMessage(message) {
    var errorMessageContainer = $('#error-message-container');
    errorMessageContainer.text(message);
    errorMessageContainer.show();  // Display the error message

    // Optionally, you can hide the error message after a certain duration
    setTimeout(function () {
      errorMessageContainer.hide();
    }, 5000);  // Hide after 5 seconds (adjust the duration as needed)
  }

  function showSuccessMessage(message) {
    var successMessageContainer = $('#success-message-container');
    successMessageContainer.text(message);
    successMessageContainer.show();  // Display the success message

    // Optionally, you can hide the success message after a certain duration
    setTimeout(function () {
      successMessageContainer.hide();
    }, 5000);  // Hide after 5 seconds (adjust the duration as needed)
  }
</script>




<!-- Add row -->
<script>
  // Handle click on "Add Row" button
  $('#addRowBtn').on('click', function () {
    // Open the add category modal
    $('#addRequestModal').modal('show');
    $('#addRequestModal input').val('');
    $('#addRequestModal select').val('');
    $('#addRequestModal textarea').val('');
  });

  // Handle click on "Save Changes" button in the modal
  $('#saveRequestBtn').on('click', function () {
    // Get the category name from the modal input
    var newRequestsAmount = $('#addRequestModal #id_amount').val();
    var newRequestsPayment = $('#addRequestModal #id_payment_method').val();
    var newRequestsVodafone = $('#addRequestModal #id_vodafone_field').val();
    var newRequestsInstapay = $('#addRequestModal #id_instapay_field').val();
    var newRequestsBank = $('#addRequestModal #id_bank_field').val();
    var newRequestsNote = $('#addRequestModal #id_note').val();
    // Send the data to the server for insertion
    $.ajax({
      url: '/affiliate/api/requests_api_marketer/',
      method: 'POST',
      data: {
        'payment_method': newRequestsPayment,
        'amount': newRequestsAmount,
        'vodafone_field': newRequestsVodafone,
        'instapay_field': newRequestsInstapay,
        'bank_field': newRequestsBank,
        'note': newRequestsNote,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      }
    }).done(function (data, textStatus, jqXHR) {
      showSuccessMessage("تم أضافة طلب سحب جديد بقيمة: " + data.amount)

      dataTable.ajax.reload();
    }).fail(function (jqXHR, textStatus, errorThrown) {
        if (jqXHR.status === 400) {
          var errors = JSON.parse(jqXHR.responseText);
          console.log(errors);
          // Handle validation errors'
          handleValidationErrors(errors);
          // if (errors && errors['error']) {
          //   console.log(errors['error']);
          //   showErrorMessage(errors['error']);
          // }


        } else {
          console.log("Unexpected error:", jqXHR.responseText);
        }
    });
    // Close the modal
    $('#addRequestModal').modal('hide');
  });
</script>


<script>

          // Initial setup
          toggleFields();

          // Toggle fields when payment method changes
          $("#id_payment_method").change(function () {
              toggleFields();
          });

          function toggleFields() {
              var paymentMethod = $("#id_payment_method").val();
              $(".payment-specific-field").hide();
              $("#" + paymentMethod + "_field").show();
          }
</script>



<script>

function notierror(field ,errors, seconds) {
    $.notify({

      title: field,
      message: errors,
      icon: 'fa fa-bell',
    }, {
      element: 'body',
      position: null,
      type: "danger",
      allow_dismiss: true,
      showProgressbar: true,
      placement: {
        from: "top",
        align: "left"
      },
      offset: 10,
      spacing: 10,
      z_index: 1500,
      delay: seconds,
      timer: 1000,
      animate: {
        enter: 'animate__animated animate__bounceInDown',
        exit: 'animate__animated animate__bounceOutUp'
      },
      template: `<div  data-notify="container" class="shadow-sm col-3 alert alert-{0} alert-dismissible fade show" role="alert">
	    <h5 data-notify="title" class="alert-heading">{1}</h5>
	    <div class="d-flex align-items-center">

	      <div class="me-2" data-notify="icon"></div>

	      <span data-notify="message" class="animate__animated animate__fadeIn animate__faster animate__delay-1s">{2}</span>

	    </div>

	    <div class="progress mt-1" style="height: 2px;" data-notify="progressbar">

	      <div class="progress-bar bg-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>

	    </div>


	    <button type="button" class="btn-close"  data-notify="dismiss" aria-label="Close"></button>

	    </div>`,
    });

  }

  function handleValidationErrors(errors) {



    if (errors) {
      var seconds = 3000;
      for (const field in errors.error) {
        if (errors.error.hasOwnProperty(field)) {
          const errorMessages = errors.error[field];

          // Display all error messages for the field with a fixed delay
          errorMessages.forEach(errorMessage => {
            notierror(`${field}`,`${errorMessage}`, seconds);
            seconds += 750; // Increment the delay for the next error message
          });
        } else {
          console.log(errors);
        }
      }
    } else {
      console.log("No validation errors received.");
    }
  }
</script>


{% endblock %}