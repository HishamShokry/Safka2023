
  

  <script>
    $(document).ready(function () {
      // ...existing initialization for Select2....

      // Initialize Select2 for product-select with your specific settings
      function initializeSelect2(selectElement) {
        selectElement.select2({
          dropdownParent: $('#addShippingForm'),
          placeholder: 'اختر منتج',
          ajax: {
            url: 'product/search/', // Adjust the URL to your Django view
            dataType: 'json',
            delay: 250,
            data: function (params) {
              return {
                term: params.term,
                page: params.page || 1
              };
            },
            processResults: function (data, params) {
              params.page = params.page || 1;
              return {
                results: data.results,
                pagination: {
                  more: data.pagination.more
                }
              };
            },
            cache: true,
          },
          dir: 'rtl',
          width: '100%',
          selectOnClose: true,
          // minimumInputLength: 1  // Uncomment if needed
        });
      }
  
      // Initialize Select2 on existing .product-select elements
      $('.product-select').each(function() {
        initializeSelect2($(this));
      });
  
      // Handle click on "Add Row" button
      $('#addRowBtn').on('click', function () {
        $('#addShippingModal').modal('show');
      });
  
  
  
  
  
      // Function to update indices for new formset entries
      function updateFormsetIndices() {
        $('#variant-formset-container .variant-form').each(function (index, element) {
          $(element).find(':input').each(function () {
            var name = $(this).attr('name').replace(/\d/, index);
            var id = 'id_' + name;
            $(this).attr({'name': name, 'id': id});
            $(this).siblings('label').attr('for', id);
          });
        });
      }
  
      // Handle click on "Add Variant" button
      $('#add-variant').on('click', function () {
        var newVariantForm = $('.variant-form:first').clone(true);
        newVariantForm.find(':input').val('');
        $('#variant-formset-container').append(newVariantForm);
        updateFormsetIndices();
        newVariantForm.find('.product-select').each(function() {
          initializeSelect2($(this));
        });
      });
  
      // Handle click on "Save Changes" button in the modal
      $('#saveShippingBtn').on('click', function () {
        var formData = new FormData(document.getElementById('addShippingForm'));
        var totalForms = $('#id_' + 'items-TOTAL_FORMS').val();
        formData.append('items-TOTAL_FORMS', totalForms);
  
        $('#variant-formset-container .variant-form').each(function (index, variantForm) {
          $(variantForm).find(':input').each(function () {
            var inputName = $(this).attr('name').replace(/-\d+-/, `-${index}-`);
            formData.append(inputName, $(this).val());
          });
        });
  
        // AJAX request to submit the form data
        $.ajax({
          url: '/affiliate/api/order_api/', // Replace with your actual API endpoint
          method: 'POST',
          contentType: false,
          processData: false,
          data: formData,
        }).done(function (data) {// Initialize Select2 for product-select with your specific settings
          function initializeSelect2(selectElement) {
            selectElement.select2({
              dropdownParent: $('#addShippingForm'),
              placeholder: 'اختر منتج',
              ajax: {
                url: 'product/search/', // Adjust the URL to your Django view
                dataType: 'json',
                delay: 250,
                data: function (params) {
                  return {
                    term: params.term,
                    page: params.page || 1
                  };
                },
                processResults: function (data, params) {
                  params.page = params.page || 1;
                  return {
                    results: data.results,
                    pagination: {
                      more: data.pagination.more
                    }
                  };
                },
                cache: true,
              },
              dir: 'rtl',
              width: '100%',
              selectOnClose: true,
              // minimumInputLength: 1  // Uncomment if needed
            });
          }
      
          // Initialize Select2 on existing .product-select elements
          $('.product-select').each(function() {
            initializeSelect2($(this));
          });
      
          // Handle click on "Add Row" button
          $('#addRowBtn').on('click', function () {
            $('#addShippingModal').modal('show');
          });
      
          // Handle click on "Add Variant" button
          $('#add-variant').on('click', function () {
            var newVariantForm = $('.variant-form:first').clone();
      
            // Clear the values in the new form
            newVariantForm.find(':input').val('');
      
            // Update IDs, labels, containers, and names with a sequence
            var formIndex = $('.variant-form').length;
            newVariantForm.find(':input').each(function () {
              var newName = this.name.replace(/-\d+-/, '-' + formIndex + '-');
              var newId = this.id.replace(/-\d+-/, '-' + formIndex + '-');
              $(this).attr({'name': newName, 'id': newId});
      
              // Update label 'for' attribute
              var labelFor = $(this).siblings('label').attr('for');
              if (labelFor) {
                var newLabelFor = labelFor.replace(/-\d+-/, '-' + formIndex + '-');
                $(this).siblings('label').attr('for', newLabelFor);
              }
            });
      
            // Append the new form and reinitialize Select2 on the select elements of the new form
            $('#variant-formset-container').append(newVariantForm);
            newVariantForm.find('.product-select').each(function() {
              initializeSelect2($(this));
            });
          });
      
          // Handle success
          console.log("Order added:", data);
          showSuccessMessage("تم أضافة اوردر جديد: " + data.name);
          dataTable.ajax.reload();
        }).fail(function (jqXHR) {
          // Handle errors
          var errors = jqXHR.responseJSON;
          console.error("Error adding order:", errors);
          showErrorMessage(errors.detail || "Error occurred");
        });
  
        // Close the modal
        $('#addShippingModal').modal('hide');
      });
    });
  </script>
  